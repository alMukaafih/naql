name: CI
on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  RUST_LOG: info
  RUST_BACKTRACE: 1
  RUSTUP_WINDOWS_PATH_ADD_BIN: 1
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  format:
    name: Format Rust Files
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Support longpaths
        run: git config core.longpaths true
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Install taplo-cli
        run: cargo install taplo-cli

      - name: Run rustfmt
        run: |
          cargo fmt --all --verbose -- --check
          taplo format --check

  lint:
    name: Lint Rust Files
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Run cargo check
        run: cargo check --workspace --all-targets --release
      - name: Run clippy
        run: cargo clippy

  check-dependencies:
    name: Check Dependencies
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout PR Branch
        uses: actions/checkout@v5

      - name: Install toolchain
        uses: dtolnay/rust-toolchain@nightly

      - name: Install cargo-udeps
        run: cargo +nightly install cargo-udeps

      - name: Detect unused dependencies using udeps
        run: cargo +nightly udeps --all-targets

  format-js:
    name: Check JS Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v5

      - name: Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn

      - name: Run Biome CI check
        run: |
          yarn install --immutable
          yarn biome ci
